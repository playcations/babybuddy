if("undefined"==typeof jQuery)throw new Error("Baby Buddy requires jQuery.");var BabyBuddy={};function preventDoubleSubmit(){return!1}function repeatMedicineDose(e,n){const t=n.innerHTML;n.innerHTML='<i class="icon-spinner icon-spin"></i>',n.disabled=!0,fetch(`/medicine/${e}/repeat-dose/`,{method:"POST",headers:{"X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value,"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{"success"===e.status?location.reload():(alert("Error: "+e.message),n.innerHTML=t,n.disabled=!1)}).catch(e=>{console.error("Error:",e),alert("An error occurred while repeating the dose."),n.innerHTML=t,n.disabled=!1})}function removeMedicineFromActive(e,n){const t=n.innerHTML;n.innerHTML='<i class="icon-spinner icon-spin"></i>',n.disabled=!0,fetch(`/medicine/${e}/remove-active/`,{method:"POST",headers:{"X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value,"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if("success"===e.status){const e=n.closest(".medicine-status-item");e.style.transition="opacity 0.3s ease",e.style.opacity="0",setTimeout(()=>{e.remove(),0===document.querySelectorAll(".medicine-status-item").length&&location.reload()},300)}else alert("Error: "+e.message),n.innerHTML=t,n.disabled=!1}).catch(e=>{console.error("Error:",e),alert("An error occurred while removing the medicine."),n.innerHTML=t,n.disabled=!1})}BabyBuddy.PullToRefresh=function(e){return{init:function(){e.init({mainElement:"body",onRefresh:this.onRefresh})},onRefresh:function(){window.location.reload()}}}(PullToRefresh),$("form").off("submit",preventDoubleSubmit),$("form").on("submit",function(){$(this).on("submit",preventDoubleSubmit)}),BabyBuddy.RememberAdvancedToggle=function(e){localStorage.setItem("advancedForm",event.newState)},window.addEventListener("load",function(){"open"===localStorage.getItem("advancedForm")&&document.querySelectorAll(".advanced-fields").forEach(function(e){e.open=!0})}),BabyBuddy.Timer=function(e){var n=null,t=null,i=null,o=new Date,r=null,d={run:function(o,s){return t=o,0===(i=e("#"+s)).length?(console.error("BBTimer: Timer element not found."),!1):0===i.find(".timer-seconds").length||0===i.find(".timer-minutes").length||0===i.find(".timer-hours").length?(console.error("BBTimer: Element does not contain expected children."),!1):(n=setInterval(this.tick,1e3),void 0!==document.hidden?r="hidden":void 0!==document.msHidden?r="msHidden":void 0!==document.webkitHidden&&(r="webkitHidden"),void window.addEventListener("focus",d.handleVisibilityChange,!1))},handleVisibilityChange:function(){!document[r]&&new Date-o>1&&d.update()},tick:function(){var e=i.find(".timer-seconds"),n=Number(e.text());if(n<59)e.text(n+1);else{e.text(0);var t=i.find(".timer-minutes"),o=Number(t.text());if(o<59)t.text(o+1);else{t.text(0);var r=i.find(".timer-hours"),d=Number(r.text());r.text(d+1)}}},update:function(){e.get("/api/timers/"+t+"/",function(e){if(e&&"duration"in e){clearInterval(n);var t=e.duration.split(/[\s:.]/);5===t.length&&(t[0]=24*parseInt(t[0])+parseInt(t[1]),t[1]=t[2],t[2]=t[3]),i.find(".timer-hours").text(parseInt(t[0])),i.find(".timer-minutes").text(parseInt(t[1])),i.find(".timer-seconds").text(parseInt(t[2])),o=new Date,n=setInterval(d.tick,1e3)}})}};return d}(jQuery),BabyBuddy.Dashboard=function(e){var n=null,t={watch:function(i,o){if(0==e("#"+i).length)return console.error("Baby Buddy: Dashboard element not found."),!1;void 0!==document.hidden?n="hidden":void 0!==document.msHidden?n="msHidden":void 0!==document.webkitHidden&&(n="webkitHidden"),void 0===window.addEventListener||void 0===document.hidden?o&&setInterval(this.update,o):(window.addEventListener("focus",t.handleVisibilityChange,!1),o&&setInterval(t.handleVisibilityChange,o))},handleVisibilityChange:function(){document[n]||t.update()},update:function(){location.reload()}};return t}(jQuery),document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".repeat-dose-btn").forEach(function(e){e.addEventListener("click",function(){const e=this.dataset.medicineId,n=this.dataset.medicineName,t=this.closest(".medicine-status-item").querySelector(".badge");let i;if(t&&t.classList.contains("bg-warning")){i=`⚠️ WARNING: ${n} is still in safety window (${t.textContent.trim()}).\n\nAre you sure you want to give another dose now?`}else i=`Repeat dose of ${n}?`;confirm(i)&&repeatMedicineDose(e,this)})}),document.querySelectorAll(".remove-medicine-btn").forEach(function(e){e.addEventListener("click",function(){const e=this.dataset.medicineId,n=this.dataset.medicineName;confirm(`Remove ${n} from active list?`)&&removeMedicineFromActive(e,this)})})});